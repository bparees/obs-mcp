name: e2e

on:
    workflow_dispatch:
    pull_request:
    push:
        branches:
            - main

concurrency:
    group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
    cancel-in-progress: true

jobs:
    e2e-tests:
        name: E2E tests
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v6

            - name: Setup E2E environment
              uses: ./.github/actions/setup-e2e

            - name: Deploy obs-mcp
              run: make test-e2e-deploy

            - name: Run E2E tests
              run: make test-e2e

            - name: Collect diagnostics on failure
              if: ${{ failure() }}
              run: |
                  echo "=== Pod status ==="
                  kubectl get pods -A
                  echo "=== obs-mcp logs ==="
                  kubectl logs -n obs-mcp -l app.kubernetes.io/name=obs-mcp --tail=100 || true
                  echo "=== Prometheus logs ==="
                  kubectl logs -n monitoring -l app.kubernetes.io/name=prometheus --tail=50 || true
                  echo "=== Events ==="
                  kubectl get events -n obs-mcp --sort-by='.lastTimestamp' || true
